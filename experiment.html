<!DOCTYPE html>
<html>
  <head>
    <title>F32</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-audio-button-response.js"></script>
    <script src="jspsych/plugin-html-button-response-flexiblelocations.js"></script>
    <script src="jspsych/plugin-audio-button-response-flexiblelocations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.2.0/papaparse.min.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>

    const jsPsych  = initJsPsych( {
        on_finish: function() {
            jsPsych.data.displayData('json');
        }
    });
    
    link_URL = 'https://raw.githubusercontent.com/rpomper/F32/main/orders/F32-Link-Order-1.csv'
    teaching_URL = 'https://raw.githubusercontent.com/rpomper/F32/main/orders/F32-Teaching-Order-1.csv'

    Papa.parse(teaching_URL, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            var teaching_trials = results.data
            console.log(teaching_trials)
            loadLinkTrials(teaching_trials);
        }
    })

    function loadLinkTrials(teaching_trials) {
        Papa.parse(link_URL, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                var link_trials = results.data
                console.log(link_trials)
                startExperiment(teaching_trials,link_trials)
            }
        })
    }

    function createExperiment(teaching_trials,link_trials) {
        var timeline = [];
        var phase = 0;
        var imageStart='<img src= "stimuli/images/';
        var numButtonStop= '.jpg"  title = "" width="100" height="100">';
        var buttonStop= '.jpg"  title = "" width="100" height="50">';
        var imageStop= '.jpg"  title = "" width="300" height="300">';
        var audioExt="stimuli/sounds/";

        var choose_phase = {
            type: jsPsychHtmlButtonResponseFlexiblelocations,
            stimulus: "Choose phase:",
            // choices: ['<p style="font-size:48px; color:red;">1</p>', '<p style="font-size:48px; color:green;">2</p>', '<p style="font-size:48px; color:blue;">3</p>','<p style="font-size:48px; color:orange;">4</p>'],
            choices: [imageStart+"1"+numButtonStop,imageStart+"2"+numButtonStop,imageStart+"3"+numButtonStop,imageStart+"4"+numButtonStop],
            prompt: "",
            block_attribute: ['inline-block','inline-block','block','inline-block'],
            grid_attribute: true,
            margin_vertical: ['10px'],
            on_finish: function(data){
                phase = data.response+1
            }
        }
        
        timeline.push(choose_phase)


        var show_trial_num = {
            type:jsPsychHtmlKeyboardResponse,
            trial_duration:500,
            response_ends_trial: false,
            stimulus: jsPsych.timelineVariable('tr_num'),
            prompt:"",
            choices: ['Enter']
        }

        var blank_screen = {
            type:jsPsychHtmlKeyboardResponse,
            trial_duration:500,
            response_ends_trial: false,
            stimulus: "",
            prompt:"",
            choices: ['Enter']
        }

        var break_screen = {
            type: jsPsychHtmlButtonResponseFlexiblelocations,
            stimulus: "<p style='font-size:90px;'>Let's take a break</p>",
            choices: imageStart+"next-button"+buttonStop,
            prompt: "",
            margin_vertical: ['20px']
        }

        var retrieve_prompt = {
            type: jsPsychAudioButtonResponseFlexiblelocations,
            trial_duration: 3000,
            response_ends_trial: false,
            stimulus: audioExt+"teaching/prompt.wav",
            choices: [imageStart+"J3"+imageStop,imageStart+"blank-button"+buttonStop],
            prompt: "",
            block_attribute: ['inline-block','block'],
            grid_attribute: false,
            margin_vertical: ['20px']
        }

        var study_prompt = {
            type: jsPsychAudioButtonResponseFlexiblelocations,
            trial_duration: 8800,
            response_ends_trial: false,
            // stimulus: audioExt+"teaching/juss.wav",
            // choices: [imageStart+"J3"+imageStop,imageStart+"blank-button"+buttonStop],
            stimulus: jsPsych.timelineVariable('stimulus'),
            choices: jsPsych.timelineVariable('prompt_image'),
            prompt: "",
            block_attribute: ['inline-block','block'],
            grid_attribute: false,
            margin_vertical: ['20px']
        }

        var click_advance = {
            type: jsPsychHtmlButtonResponseFlexiblelocations,
            // choices: [imageStart+"J3"+imageStop,imageStart+"next-button"+buttonStop],
            stimulus: "",
            choices: jsPsych.timelineVariable('click_image'),
            prompt: "",
            block_attribute: ['inline-block','block'],
            grid_attribute: false,
            margin_vertical: ['20px']
        }

        var link_prompt = {
            type: jsPsychAudioButtonResponseFlexiblelocations,
            stimulus: audioExt+"link/juss.wav",
            // choices: ['<p style="font-size:48px; color:red;">1</p>', '<p style="font-size:48px; color:green;">2</p>', '<p style="font-size:48px; color:blue;">3</p>','<p style="font-size:48px; color:orange;">4</p>'],
            choices: [imageStart+"J3"+imageStop,imageStart+"A3"+imageStop,imageStart+"A33"+imageStop],
            prompt: "",
            block_attribute: ['inline-block','inline-block','block'],
            grid_attribute: false,
            margin_vertical: ['10px'],
            on_finish: function(data){
                console.log(data)
            }
        }

        /*
        * TEACHING
        */

        // var phase = jsPsych.data.get().filter({stimulus: 'Choose phase:'}).response + 1
        // console.log(jsPsych.data.get())

        var cur_trials = teaching_trials.filter(function(trial){return trial.set === 1})
        console.log(cur_trials)

        for (var i = 0; i < cur_trials.length; i++) {

            if (cur_trials[i]['block'] > 2 && cur_trials[i]['block_num'] == 1) {
                timeline.push(break_screen)
            }

            if (cur_trials[i]['tr_type']=='study'){
                var study_trial = {
                    timeline: [show_trial_num,blank_screen,study_prompt,click_advance],
                    timeline_variables:[
                        {tr_num: "<p style='font-size:90px;'>"+cur_trials[i]['tr_num']+"</p>",
                        prompt_image: [imageStart+cur_trials[i]['alien']+imageStop,imageStart+"blank-button"+buttonStop],
                        click_image: [imageStart+cur_trials[i]['alien']+imageStop,imageStart+"next-button"+buttonStop],
                        button:imageStart+"blank-button"+buttonStop,
                        stimulus:audioExt+"teaching/"+cur_trials[i]['audio']+".wav"}
                    ],
                    conditional_function: function() {
                        if(phase == 1 | phase ==2) {
                            return true;
                        } else {
                            return false;
                        }
                    }
                }
                timeline.push(study_trial)
            }

            if (cur_trials[i]['tr_type']=='retrieve') {
                var retrieve_trial = {
                    timeline: [show_trial_num,blank_screen,retrieve_prompt,click_advance],
                    timeline_variables:[
                        {tr_num: "<p style='font-size:90px;'>"+cur_trials[i]['tr_num']+"</p>",
                        prompt_image: [imageStart+cur_trials[i]['alien']+imageStop,imageStart+"blank-button"+buttonStop],
                        click_image: [imageStart+cur_trials[i]['alien']+imageStop,imageStart+"next-button"+buttonStop],
                        button:imageStart+"blank-button"+buttonStop,
                        stimulus:audioExt+"teaching/prompt.wav"}
                    ],
                    conditional_function: function() {
                        if(phase == 1 | phase ==2) {
                            return true;
                        } else {
                            return false;
                        }
                    }
                }
                timeline.push(retrieve_trial)
            }
        }

        return timeline

    }

    function startExperiment(teaching_trials,link_trials) {
        jsPsych.run(createExperiment(teaching_trials,link_trials))
    }
    // function startExperiment(teaching_trials,link_trials,phase) {
    //     jsPsych.run(createExperiment(teaching_trials,link_trials,phase))
    // }
    // jsPsych.run([choose_phase,study_trial,retrieval_trial,link_trial]);
  </script>
</html>