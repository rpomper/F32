<!DOCTYPE html>
<html>
  <head>
    <title>F32</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-audio-button-response.js"></script>
    <script src="jspsych/plugin-html-button-response-flexiblelocations.js"></script>
    <script src="jspsych/plugin-audio-button-response-flexiblelocations.js"></script>
    <script src="jspsych/plugin-reconstruction.js"></script>
    <script src="jspsych/plugin-free-sort.js"></script>
    <script src="jspsych/plugin-video-keyboard-response.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.2.0/papaparse.min.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>

    const jsPsych  = initJsPsych( {
        override_safe_mode: true,
        on_finish: function() {
            jsPsych.data.displayData('json');
            var show_results_ld = jsPsych.data.get().filter({test_tr_type:'test_ld'})
            // console.log(show_results_ld)
            uploadToRedcap("D988A480A47E17456634FDA91DB82408")
    
        }
    });

    var subject_id = jsPsych.data.getURLVariable('sub')
    var trial_order = jsPsych.data.getURLVariable('order')
    var filter_week = jsPsych.data.getURLVariable('week')
    let today = new Date()
    var DoT = {"month":today.getMonth()+1,"day":today.getDate(),"year":today.getFullYear(),"hour":today.getHours(),"min":today.getMinutes()}

    var global_phase = {}

    teaching_URL = 'https://raw.githubusercontent.com/rpomper/F32/main/orders/F32-Teaching-Order-'+trial_order.toString()+'.csv'
    recall_URL = 'https://raw.githubusercontent.com/rpomper/F32/main/orders/F32-Recall-Order-'+trial_order.toString()+'.csv'
    form_URL = 'https://raw.githubusercontent.com/rpomper/F32/main/orders/F32-Form-Order-'+trial_order.toString()+'.csv'
    link_URL = 'https://raw.githubusercontent.com/rpomper/F32/main/orders/F32-Link-Order-'+trial_order.toString()+'.csv'
    ld_URL = 'https://raw.githubusercontent.com/rpomper/F32/main/orders/F32-LD-Order-'+trial_order.toString()+'.csv'
    preload_URL = 'https://raw.githubusercontent.com/rpomper/F32/main/orders/F32-preload.csv'

    
    Papa.parse(preload_URL, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            var preload_stims = results.data
            console.log("Sounds to preload:")
            console.log(preload_stims[0]['audio'].split(',').slice(0,-1))
            console.log("Images to preload:")
            console.log(preload_stims[0]['images'].split(',').slice(0,-1))
            console.log("Videos to preload:")
            console.log(preload_stims[0]['video'].split(',').slice(0,-1))

            loadTeachingTrials(preload_stims);
        }
    })

    function loadTeachingTrials(preload_stims) {
        Papa.parse(teaching_URL, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                var teaching_trials = results.data.filter(function(subset){return subset.week == filter_week})
                console.log("Teaching:")
                console.log(teaching_trials)
                loadRecallTrials(preload_stims,teaching_trials);
            }
        })
    }

    function loadRecallTrials(preload_stims,teaching_trials) {
        Papa.parse(recall_URL, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                var recall_trials = results.data.filter(function(subset){return subset.week == filter_week})
                console.log("Recall:")
                console.log(recall_trials)
                loadFormTrials(preload_stims,teaching_trials,recall_trials)
            }
        })
    }

    function loadFormTrials(preload_stims,teaching_trials,recall_trials) {
        Papa.parse(form_URL, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                var form_trials = results.data.filter(function(subset){return subset.week == filter_week})
                console.log("Form:")
                console.log(form_trials)
                loadLinkTrials(preload_stims,teaching_trials,recall_trials,form_trials)
            }
        })
    }

    function loadLinkTrials(preload_stims,teaching_trials,recall_trials,form_trials) {
        Papa.parse(link_URL, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                var link_trials = results.data.filter(function(subset){return subset.week == filter_week})
                console.log("Link:")
                console.log(link_trials)
                loadLDTrials(preload_stims,teaching_trials,recall_trials,form_trials,link_trials)
            }
        })
    }

    function loadLDTrials(preload_stims,teaching_trials,recall_trials,form_trials,link_trials) {
        Papa.parse(ld_URL, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                var ld_trials = results.data.filter(function(subset){return subset.week == filter_week})
                console.log("LD:")
                console.log(ld_trials)
                startExperiment(preload_stims,teaching_trials,recall_trials,form_trials,link_trials,ld_trials)
            }
        })
    }

    function postToRedcap(body) {
        // https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch
        return fetch("https://study.boystown.org/api/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                Accept: "application/json",
            },
        body: body,
        });
    }

    function uploadToRedcap(token) {
        postToRedcap("token=" + token + "&content=generateNextRecordName")
            .then(function (response) {
                return response.text();
            })
            .then(function (text) {
                const id = text;
                postToRedcap(
                    "token=" +
                        token +
                        "&content=record&format=json&type=flat&overwriteBehavior=normal&forceAutoNumber=false&data=[" +
                        JSON.stringify({record_id: id, subject_num: subject_id, date: JSON.stringify(DoT), order: trial_order, week: filter_week, phase: global_phase.phase,
                            results_form:jsPsych.data.get().filter({test_tr_type: 'test_form'}).json(),
                            results_link:jsPsych.data.get().filter({test_tr_type: 'test_link'}).json(),
                            results_ld:jsPsych.data.get().filter({test_tr_type: 'test_ld'}).json()
                        }) +
                        // data_export+
                        "]&returnContent=count&returnFormat=json"
                ).then(function (response) {
                    console.log(response.text());
                });
            });
        console.log(jsPsych.data.get().filter({test_tr_type: 'test_ld'}).json())
    }

    function createExperiment(preload_stims,teaching_trials,recall_trials,form_trials,link_trials,ld_trials) {

        var timeline = [];
        var phase = 0;
        var imageStart='<img src= "stimuli/images/';
        var numButtonStop= '.jpg"  title = "" width="100" height="100">';
        var numPadStop= '.jpg"  title = "" width="800" height="600">'
        var routePadStop= '.jpg"  title = "" width="1162" height="600">'
        var buttonStop= '.jpg"  title = "" width="100" height="50">';
        var squareButtonStop = '.jpg"  title = "" width="200" height="200">';
        var imageStop= '.jpg"  title = "" width="300" height="300">';
        var audioExt="stimuli/sounds/";

        var choose_phase = {
            type: jsPsychHtmlButtonResponseFlexiblelocations,
            stimulus: "Choose phase:",
            choices: [imageStart+"1"+numButtonStop,imageStart+"2"+numButtonStop,imageStart+"3"+numButtonStop,imageStart+"4"+numButtonStop],
            prompt: "",
            block_attribute: ['inline-block','inline-block','block','inline-block'],
            grid_attribute: true,
            margin_vertical: ['10px'],
            on_finish: function(data){
                phase = data.response+1
                global_phase.phase = phase
            }
        }
        
        timeline.push(choose_phase)

        /* 
        ---------------------
        INTER TRIAL INTERVALS
        ---------------------

        in the .csv files, the column tr_num is cumulative across all of the trials (teaching, recall, form, link, and LD)
        we need to adjust these numbers depending on the phase
        when phase = 1,
            children will complete the teaching trials for the 1st time, so no adjustment is necessary
        when phase = 2,
            children will repeat the same teaching trials again, so add teaching_trials.length
            children will complete the test trials after that 2nd repetition of teaching, so also add teaching_trials.length
        when phase = 3, 
            it is the beginning of the second day
            children will first complete the test trials without any preceding teaching trials, so subtract teaching_trials.length
        when phase = 4,
            children will complete the lexical decision trials after the test trials, so also subtract teaching_trials.length
        */

        function adjust_tr_num(tr_num_order) {

            // var tr_num_order = jsPsych.timelineVariable('tr_num')

            // if (phase==2) {
            //     var tr_num_adj = teaching_trials.length
            //     // var tr_num_adj = teaching_trials.filter(function(trial){return trial.set === 1}).length
            // } else if (phase == 3 || phase == 4) {
            //     var tr_num_adj = - teaching_trials.length
            //     // var tr_num_adj = - teaching_trials.filter(function(trial){return trial.set === 1}).length
            // } else {
            //     var tr_num_adj = 0
            // }

            if (global_phase.phase==1) {
                var tr_num_adj = 0
            } else if (global_phase.phase==2){
                var tr_num_adj = teaching_trials.length
            } else {
                var tr_num_adj = -teaching_trials.length
            }

            var tr_num_final = tr_num_order + tr_num_adj

            return tr_num_final
        }

        var show_trial_num = {
            type:jsPsychHtmlKeyboardResponse,
            trial_duration:500,
            response_ends_trial: false,
            stimulus: function() {
                return "<p style='font-size:90px;'>"+adjust_tr_num(jsPsych.timelineVariable('tr_num')).toString()+"</p>"
                // return "<p style='font-size:90px;'>"+jsPsych.timelineVariable('tr_num').toString()+"</p>"
            },
            prompt:"",
            choices: ['Enter']
        }

        var blank_screen = {
            type:jsPsychHtmlKeyboardResponse,
            trial_duration:500,
            response_ends_trial: false,
            stimulus: "",
            prompt:"",
            choices: ['Enter']
        }

        var break_screen = {
            type: jsPsychHtmlButtonResponseFlexiblelocations,
            stimulus: jsPsych.timelineVariable('break_message'),
            choices: [imageStart+"next-button"+buttonStop],
            prompt: "",
            margin_vertical: ['20px']
        }

        var mae_screen = {
            type: jsPsychHtmlButtonResponseFlexiblelocations,
            stimulus: jsPsych.timelineVariable('stimulus'),
            choices: jsPsych.timelineVariable('choices'),
            prompt: "",
            margin_vertical:['20px']
        }
        
        /* 
        ------------
        INSTRUCTIONS
        ------------
        */

        var mae_start = {
            timeline: [mae_screen],
            timeline_variables:[
                {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:32px;'>This is Mae. She is an astronaut! <br><br> Mae will introduce you to some of her alien friends. </p>",
                choices: [imageStart+"start-button"+buttonStop]}
            ],
            conditional_function: function() {
                    if(phase == 1 | phase == 2) {
                        return true
                    } else {
                        return false
                    }
            }
        }
        timeline.push(mae_start)

        /* 
        ------------
        GAME
        ------------
        */

        function play_game(){

            var mae_before_game = {
                timeline: [mae_screen],
                timeline_variables:[
                    {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:32px;'>Let's play a game. We are going to help Mae travel through space. </p>",
                    choices: [imageStart+"next-button"+buttonStop]}
                ],
                conditional_function: function() {
                    if(phase == 1 | phase == 2) {
                        return true
                    } else {
                        return false
                    }
                }

            }

            timeline.push(mae_before_game)

            // READY SHIP
            var spaceship_parts = ['stimuli/images/spaceship-1.jpg','stimuli/images/spaceship-2.jpg','stimuli/images/spaceship-3.jpg']
        
            var assemble_ship = {
                type: jsPsychFreeSort,
                stimuli: spaceship_parts,
                stim_height: 150,
                stim_width: 150,
                sort_area_height: 600,
                sort_area_width: 800,
                stim_starts_inside: false,
                column_spread_factor: 0.5,
                scale_factor:1,
                set_background:'launch-pad-background',
                prompt: "",
                button_label: [imageStart+"next-button"+buttonStop]
            }

            var luggage = ['stimuli/images/luggage-1.jpg','stimuli/images/luggage-2.jpg','stimuli/images/luggage-3.jpg']
            
            var pack_ship = {
                type: jsPsychFreeSort,
                stimuli: luggage,
                stim_height: 150,
                stim_width: 150,
                sort_area_height: 600,
                sort_area_width: 800,
                stim_starts_inside: false,
                column_spread_factor: 0.5,
                scale_factor:1,
                set_background:'launch-pad-ship-background',
                prompt: "",
                button_label: [imageStart+"next-button"+buttonStop],
            };

            var blank_video = {
                type: jsPsychVideoKeyboardResponse,
                stimulus: ['stimuli/video/blank.mp4'],
                width:1163,
                height:600,
                autoplay:true,
                rate: 1,
                start:0,
                controls:false,
                trial_duration: 1,
                trial_ends_after_video: true
            }

            var ready_ship = {
                timeline:[assemble_ship,pack_ship,blank_video],
                conditional_function: function() {
                    if(phase == 1 | phase == 2) {
                        return true
                    } else {
                        return false
                    }
                }
            }

            timeline.push(ready_ship)


            // UNLOCK DOOR

            var num_pad = {
                type: jsPsychAudioButtonResponseFlexiblelocations,
                trial_duration: null,
                response_ends_trial: true,
                margin_veritical: ['25px'],
                block_attribute: ['inline-block'],
                stimulus: jsPsych.timelineVariable('sound'),
                choices: jsPsych.timelineVariable('image')
            }


            for (var i = 0; i <= 5; i++) {
                var num_pad_entry = {
                    timeline:[num_pad],
                    timeline_variables:[
                        {
                            sound: 'stimuli/sounds/games/key-'+i.toString()+'.wav',
                            image: [imageStart+'numpad-'+i.toString()+numPadStop]
                        }
                    ],
                    conditional_function: function() {
                        if(phase == 1 | phase == 2) {
                            return true
                        } else {
                            return false
                        }
                    }
                }
                timeline.push(num_pad_entry)
            }

            var num_pad_end = {
                type: jsPsychAudioButtonResponseFlexiblelocations,
                trial_duration: 500,
                response_ends_trial: false,
                margin_veritical: ['25px'],
                block_attribute: ['inline-block'],
                stimulus: 'stimuli/sounds/games/key-6.wav',
                choices: [imageStart+'numpad-6'+numPadStop],
            }

            var door_open = {
                type: jsPsychVideoKeyboardResponse,
                stimulus: ['stimuli/video/door.mp4'],
                width:1163,
                height:600,
                autoplay:true,
                rate: 1,
                start:0,
                controls:false,
                // choices: ['Enter'],
                trial_ends_after_video: true
            }

            var unlock_door = {
                timeline:[num_pad_end,door_open],
                conditional_function: function() {
                    if(phase == 1 | phase == 2) {
                        return true
                    } else {
                        return false
                    }
                }
            }

            timeline.push(unlock_door)


            // PLOT COURSE

            var display_route_vid = {
                type: jsPsychVideoKeyboardResponse,
                stimulus: ['stimuli/video/route.mp4'],
                width:1162,
                height:600,
                autoplay:true,
                rate: 1,
                start:0,
                controls:false,
                // choices: ['Enter'],
                trial_ends_after_video: true
            }

            var play_display_route_vid = {
                timeline: [display_route_vid],
                conditional_function: function() {
                    if(phase == 1 | phase == 2) {
                        return true
                    } else {
                        return false
                    }
                }
            }
            timeline.push(play_display_route_vid)

            var route_pad = {
                type: jsPsychAudioButtonResponseFlexiblelocations,
                trial_duration: jsPsych.timelineVariable('dur'),
                response_ends_trial: jsPsych.timelineVariable('resp'),
                margin_veritical: ['25px'],
                block_attribute: ['inline-block'],
                stimulus: jsPsych.timelineVariable('sound'),
                choices: jsPsych.timelineVariable('image')
            }

            for (var i = 0; i <= 3; i++) {
                if(i==3){
                    var obj = {
                        dur: 500,
                        resp: false,
                        sound: 'stimuli/sounds/games/key-6.wav',
                        image: [imageStart+'route-'+i.toString()+routePadStop]
                    }
                } else {
                    var obj = {
                        dur: null,
                        resp: true,
                        sound: 'stimuli/sounds/games/key-'+i.toString()+'.wav',
                        image: [imageStart+'route-'+i.toString()+routePadStop]
                    }
                }
                var route_pad_entries = {
                    timeline:[route_pad],
                    timeline_variables:[obj],
                    conditional_function: function() {
                        if(phase == 1 | phase == 2) {
                            return true
                        } else {
                            return false
                        }
                    }
                }
                timeline.push(route_pad_entries)
            }

            var display_shift_vid = {
                type: jsPsychVideoKeyboardResponse,
                stimulus: ['stimuli/video/route-swap.mp4'],
                width:1162,
                height:600,
                autoplay:true,
                rate: 1,
                start:0,
                controls:false,
                // choices: ['Enter'],
                trial_ends_after_video: true
            }

            var play_display_route_vid = {
                timeline: [display_shift_vid],
                conditional_function: function() {
                    if(phase == 1 | phase == 2) {
                        return true
                    } else {
                        return false
                    }
                } 
            }

            timeline.push(play_display_route_vid)

            for (var i = 0; i <= 3; i++) {
                if(i==3){
                    var obj = {
                        dur: 500,
                        resp: false,
                        sound: 'stimuli/sounds/games/key-6.wav',
                        image: [imageStart+'route-'+(i+4).toString()+routePadStop]
                    }
                } else {
                    var obj = {
                        dur: null,
                        resp: true,
                        sound: 'stimuli/sounds/games/key-'+i.toString()+'.wav',
                        image: [imageStart+'route-'+(i+4).toString()+routePadStop]
                    }
                }
                var route_pad_entries = {
                    timeline:[route_pad],
                    timeline_variables:[obj],
                    conditional_function: function() {
                        if(phase == 1 | phase == 2) {
                            return true
                        } else {
                            return false
                        }
                    }
                }
                timeline.push(route_pad_entries)
            }
            
            // LIFT OFF

            var launch_button = {
                type: jsPsychAudioButtonResponseFlexiblelocations,
                // trial_duration: 500,
                response_ends_trial: true,
                margin_veritical: ['25px'],
                block_attribute: ['inline-block'],
                stimulus: 'stimuli/sounds/games/key-0.wav',
                choices: [imageStart+'launch-button'+numPadStop],
            }
            
            var launch_button_click = {
                type: jsPsychVideoKeyboardResponse,
                stimulus: ['stimuli/video/launch-button.mp4'],
                width:800,
                height:600,
                autoplay:true,
                rate: 1,
                start:0,
                controls:false,
                // choices: ['Enter'],
                trial_ends_after_video: true
            }

            var lift_off_video = {
                type: jsPsychVideoKeyboardResponse,
                stimulus: ['stimuli/video/liftoff.mp4'],
                width:800,
                height:800,
                rate: 1,
                start:0,
                controls:false,
                // choices: ['Enter'],
                trial_ends_after_video: true
            }

            var lift_off = {
                timeline: [launch_button,launch_button_click,lift_off_video],
                conditional_function: function() {
                    if(phase == 1 | phase == 2) {
                        return true
                    } else {
                        return false
                    }
                }
            }

            timeline.push(lift_off)


            var mae_after_game = {
                timeline: [mae_screen],
                timeline_variables:[
                    {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:32px;'>Great job! <br><br> Mae will now introduce you to some of her alien friends. </p>",
                    choices: [imageStart+"next-button"+buttonStop]}
                ],
                conditional_function: function() {
                    if(phase == 1 | phase == 2) {
                        return true
                    } else {
                        return false
                    }
                }
            }

            timeline.push(mae_after_game)

        }

        /* 
        ---------------------
        STUDY TRIALS
        ---------------------
        */

        var study_prompt = {
            type: jsPsychAudioButtonResponseFlexiblelocations,
            trial_duration: jsPsych.timelineVariable('tr_dur'),
            stimulus: jsPsych.timelineVariable('name'),
            choices: jsPsych.timelineVariable('alien'),
            prompt: "",
            response_ends_trial: false,
            block_attribute: ['inline-block','block'],
            grid_attribute: false,
            margin_vertical: ['20px']
        }

        var retrieve_prompt = {
            type: jsPsychAudioButtonResponseFlexiblelocations,
            trial_duration: jsPsych.timelineVariable('tr_dur'),
            stimulus: audioExt+"teaching/prompt.wav",
            choices: jsPsych.timelineVariable('alien'),
            prompt: "",
            response_ends_trial: false,
            block_attribute: ['inline-block','block'],
            grid_attribute: false,
            margin_vertical: ['20px']
        }

        var click_advance = {
            type: jsPsychHtmlButtonResponseFlexiblelocations,
            stimulus: "",
            choices: jsPsych.timelineVariable('alien_click'),
            prompt: "",
            block_attribute: ['inline-block','block'],
            grid_attribute: false,
            margin_vertical: ['20px']
        }

        /* 
        ---------------------
        TEST TRIALS
        ---------------------
        */

        var form_prompt = {
            type: jsPsychAudioButtonResponseFlexiblelocations,
            stimulus: jsPsych.timelineVariable('name'),
            choices: jsPsych.timelineVariable('dots'),
            prompt: "",
            block_attribute: ['inline-block','inline-block','inline-block'],
            response_ends_trial: jsPsych.timelineVariable('response'),
            trial_duration: jsPsych.timelineVariable('tr_dur'),
            grid_attribute: false,
            margin_vertical: ['10px'],
            margin_horizontal: ['100px'],
            data: jsPsych.timelineVariable('data'),
            on_finish: function(data){
                if (jsPsych.timelineVariable('log_data')) {
                    data.phase = phase
                    data.test_tr_type = 'test_form'
                    // data.tr_num_disp = cur_tr_num
                    data.correct = data.response == data.correct_response
                    // console.log(data)
                }
            }
        }
        
        var link_prompt = {
            type: jsPsychAudioButtonResponseFlexiblelocations,
            stimulus: jsPsych.timelineVariable('name'),
            choices: jsPsych.timelineVariable('aliens'),
            prompt: "",
            block_attribute: ['inline-block','inline-block','block'],
            response_ends_trial: jsPsych.timelineVariable('response'),
            trial_duration: jsPsych.timelineVariable('tr_dur'),
            grid_attribute: false,
            margin_vertical: ['10px'],
            data: jsPsych.timelineVariable('data'),
            on_finish: function(data){
                data.phase = phase
                data.test_tr_type = 'test_link'
                // data.tr_num_disp = cur_tr_num
                data.correct = data.response == data.correct_response
                // console.log(data)
            }
        }

        var ld_prompt = {
            type: jsPsychAudioButtonResponseFlexiblelocations,
            stimulus: jsPsych.timelineVariable('name'),
            choices: [imageStart+"smiley-face"+squareButtonStop,imageStart+"frowny-face"+squareButtonStop],
            prompt: "",
            block_attribute: ['inline-block','inline-block'],
            response_ends_trial: jsPsych.timelineVariable('response'),
            trial_duration: jsPsych.timelineVariable('tr_dur'),
            grid_attribute: false,
            margin_vertical: ['10px'],
            margin_horizontal: ['100px'],
            data: jsPsych.timelineVariable('data'),
            on_finish: function(data){
                data.phase = phase
                data.test_tr_type = 'test_ld'
                // data.tr_num_disp = cur_tr_num
                data.correct = data.response == data.correct_response
                if(data.correct) {data.accuracy = 1} else {data.accuracy = 0}
                // console.log(data)
            }
        }

        var ld_feedback = {
            type: jsPsychHtmlButtonResponseFlexiblelocations,
            stimulus: function(){
                var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
                if(last_trial_correct){
                    return imageStart+'correct'+squareButtonStop
                } else {
                    return imageStart+'incorrect'+squareButtonStop
                }
            },
            choices: [imageStart+"next-button"+buttonStop],
            prompt: "",
            margin_vertical: ['20px']
        }

        var ld_acc = {
            type: jsPsychHtmlButtonResponseFlexiblelocations,
            stimulus: function(){
                var cur_rep = jsPsych.data.get().filter({condition:"ld_practice"}).select('block').max()
                var ld_prac_n = jsPsych.data.get().filter({condition:"ld_practice",block:cur_rep})
                var ld_prac_correct = ld_prac_n.filter({correct:true}).count()
                var ld_prac_accuracy = Math.round(ld_prac_correct/ld_prac_n.count()*100)
                // console.log("debugging...")
                // console.log(ld_prac_n)
                // console.log(ld_prac_correct)
                // console.log(ld_prac_accuracy)
                if(ld_prac_accuracy >= 50){
                    return "Accuracy was: "+ld_prac_accuracy+"%."
                } else {
                    return "Accuracy was: "+ld_prac_accuracy+"%. Let's practice some more."
                }
            },
            choices: [imageStart+"next-button"+buttonStop],
            prompt: "",
            margin_vertical: ['20px']
        }

        var show_ld_acc = {
            timeline: [ld_acc],
            conditional_function: function() {
                var cur_rep = jsPsych.data.get().filter({condition:"ld_practice"}).select('block').max()
                var ld_prac_n = jsPsych.data.get().filter({condition:"ld_practice",block:cur_rep}).count()
                if(ld_prac_n == 6) { 
                    return true
                } else {
                    return false
                }
            }
        }

        /*
        ------------------------
        ASSEMBLE TEACHING TRIALS
        ------------------------
        */

        var preload_1 = {
            type: jsPsychPreload,
            auto_preload: true,
            // images: ['/stimuli/images/A1.jpg','/stimuli/images/A3.jpg','/stimuli/images/A33.jpg','/stimuli/images/B2.jpg','/stimuli/images/B23.jpg','/stimuli/images/C31.jpg','/stimuli/images/E1.jpg','/stimuli/images/E3.jpg','/stimuli/images/G3.jpg','/stimuli/images/I1.jpg','/stimuli/images/J2.jpg','/stimuli/images/J3.jpg'],
            // audio: ['stimuli/sounds/teaching/chev.wav','stimuli/sounds/teaching/darg.wav','stimuli/sounds/teaching/foob.wav','stimuli/sounds/teaching/gazzer.wav','stimuli/sounds/teaching/heab.wav','stimuli/sounds/teaching/juss.wav','stimuli/sounds/teaching/koba.wav','stimuli/sounds/teaching/kulp.wav','stimuli/sounds/teaching/modi.wav','stimuli/sounds/teaching/pyzer.wav','stimuli/sounds/teaching/sarl.wav','stimuli/sounds/teaching/wilp.wav'],
            images: preload_stims[0]['images'].split(',').slice(0,-1), 
            audio: preload_stims[0]['audio'].split(',').slice(0,-1),
            conditional_function: function() {
                if(phase == 1 | phase == 2) {
                    return true
                } else {
                    return false
                }
            },
            on_error: function(file) {
                console.log('Error: ',file);
            },
            on_success: function(file) {
                // console.log('Loaded: ',file);
            },

        }

        timeline.push(preload_1)

        play_game()

        // var cur_trials = teaching_trials.filter(function(trial){return trial.set === 1})
        var cur_trials = teaching_trials

        for (var i = 0; i < cur_trials.length; i++) {

            // break between teaching blocks
            if (cur_trials[i]['block'] > 1 && cur_trials[i]['block_tr_num'] == 1) {
                // play_game()

                var mae_teaching_break = {
                    timeline: [mae_screen],
                    timeline_variables:[
                        {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:32px;'>Great job! <br><br> Mae will now introduce you to more alien friends. </p>",
                        choices: [imageStart+"next-button"+buttonStop]}
                    ],
                    conditional_function: function() {
                        if(phase == 1 | phase == 2) {
                            return true
                        } else {
                            return false
                        }
                    }
                }

                timeline.push(mae_teaching_break)

            }

            // var cur_tr_num = adjust_tr_num(cur_trials[i]['tr_num'])
            var cur_tr_num = cur_trials[i]['tr_num']
            var cur_alien = imageStart+cur_trials[i]['alien']+imageStop
            var cur_name = audioExt+"teaching/"+cur_trials[i]['audio']+".wav"
            var cur_dur = cur_trials[i]['tr_dur']

            // study trial
            if (cur_trials[i]['tr_type']=='study'){
                var study_trial = {
                    timeline: [show_trial_num,blank_screen,study_prompt,click_advance],
                    timeline_variables:[
                        {tr_num: cur_tr_num,
                        alien: [cur_alien,imageStart+"blank-button"+buttonStop],
                        alien_click: [cur_alien,imageStart+"next-button"+buttonStop],
                        name: cur_name,
                        button: imageStart+"blank-button"+buttonStop,
                        tr_dur: cur_dur
                        }
                    ],
                    conditional_function: function() {
                        if(phase == 1 | phase ==2) {
                            return true;
                        } else {
                            return false;
                        }
                    }
                }
                timeline.push(study_trial)
            }

            // retrieve trial
            if (cur_trials[i]['tr_type']=='retrieve') {
                var retrieve_trial = {
                    timeline: [show_trial_num,blank_screen,retrieve_prompt,click_advance],
                    timeline_variables:[
                        {tr_num: cur_tr_num,
                        alien: [cur_alien,imageStart+"blank-button"+buttonStop],
                        alien_click: [cur_alien,imageStart+"next-button"+buttonStop],
                        name: audioExt+"teaching/prompt.wav",
                        button: imageStart+"blank-button"+buttonStop,
                        tr_dur: cur_dur
                        }
                    ],
                    conditional_function: function() {
                        if(phase == 1 | phase ==2) {
                            return true;
                        } else {
                            return false;
                        }
                    }
                }
                timeline.push(retrieve_trial)
            }
        }


        /*
        ----------------------
        ASSEMBLE RECALL TRIALS
        ----------------------
        */

        // if Phase = 2, testing is on day 1 and preceded by teaching trials, so tr_num is correct
        // if Phase = 3, testing is on day 2 and _not_ preceded by teaching trials, so tr_num

        var recall_instructions = {
            timeline: [mae_screen],
            timeline_variables:[
                {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:32px;'>Great job! <br><br> Mae will ask you to name the different kinds of aliens. <br> It is ok if you don't remember the entire name. Just say whatever you remember and it is ok to guess. </p>",
                choices: [imageStart+"next-button"+buttonStop]}
            ],
            conditional_function: function() {
                if(phase == 2 | phase == 3) {
                    return true
                } else {
                    return false
                }
            },
        }
                
        timeline.push(recall_instructions)

        // var cur_trials = recall_trials.filter(function(trial){return trial.set === 1})
        var cur_trials = recall_trials

        for (var i = 0; i < cur_trials.length; i++) {

            // break between recall blocks
            if (cur_trials[i]['block'] > 1 && cur_trials[i]['block_tr_num'] == 1) {

                var recall_break = {
                    timeline: [mae_screen],
                    timeline_variables:[
                        {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:32px;'>Great job! <br><br> Mae will ask you to name the different kinds of aliens one more time. </p>",
                        choices: [imageStart+"next-button"+buttonStop]}
                    ],
                    conditional_function: function() {
                        if(phase == 2 | phase == 3) {
                            return true
                        } else {
                            return false
                        }
                    },
                }
                
                timeline.push(recall_break)
            }

            // var cur_tr_num = adjust_tr_num(cur_trials[i]['tr_num'])
            var cur_tr_num = cur_trials[i]['tr_num']
            var cur_alien = imageStart+cur_trials[i]['alien']+imageStop
            var cur_dur = cur_trials[i]['tr_dur']

            var retrieve_trial = {
                timeline: [show_trial_num,blank_screen,retrieve_prompt,click_advance],
                timeline_variables:[
                    {tr_num: cur_tr_num,
                    alien: [cur_alien,imageStart+"blank-button"+buttonStop],
                    alien_click: [cur_alien,imageStart+"next-button"+buttonStop],
                    name: audioExt+"teaching/prompt.wav",
                    button: imageStart+"blank-button"+buttonStop,
                    tr_dur: cur_dur
                    }
                ],
                conditional_function: function() {
                    if(phase == 2 | phase == 3) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }
            timeline.push(retrieve_trial)
        }

        /*
        --------------------
        ASSEMBLE FORM TRIALS
        --------------------
        */

        var form_instructions = {
            timeline: [mae_screen],
            timeline_variables:[
                {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:32px;'>Great job! <br><br> Mae will say three words. <br> Click the dot that matches an alien name you just learned. </p>",
                choices: [imageStart+"next-button"+buttonStop]}
            ],
            conditional_function: function() {
                if(phase == 2 | phase == 3) {
                    return true
                } else {
                    return false
                }
            },
        }
                
        timeline.push(form_instructions)

        // var cur_trials = form_trials.filter(function(trial){return trial.set === 1})
        var cur_trials = form_trials

        for (var i = 0; i < cur_trials.length; i++) {

            // break between form blocks
            if (cur_trials[i]['block'] > 1 && cur_trials[i]['block_tr_num'] == 1) {

                var form_break = {
                    timeline: [mae_screen],
                    timeline_variables:[
                        {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:32px;'>Great job! <br><br> Mae will say all the words one more time. <br> Remember to click the dot that matches an alien name you just learned. </p>",
                        choices: [imageStart+"next-button"+buttonStop]}
                    ],
                    conditional_function: function() {
                        if(phase == 2 | phase == 3) {
                            return true
                        } else {
                            return false
                        }
                    },
                }
                
                timeline.push(form_break)
            }

            // var cur_tr_num = adjust_tr_num(cur_trials[i]['tr_num'])
            var cur_tr_num = cur_trials[i]['tr_num']
            var dot = imageStart+"dot"+numButtonStop
            var blank_dot = imageStart+"blank-dot"+numButtonStop

            for (var j = 1; j <4; j++) {
                // each trial will have 3 steps (j=1, 2, 3)

                // for each step, determine the name that will be heard (from trial order)
                var cur_name = audioExt+"dot/"+cur_trials[i]['sound'+j.toString()]+".wav"

                // determine the number of visible dots (1, 2, then 3)
                // and blank dots (2, 1, 0) to be displayed
                var cur_dots = []
                for (var k = 0; k < j; k++) {
                    cur_dots.push(dot)
                }
                for (var l = 2; l>=j; l--){
                    cur_dots.push(blank_dot)
                }

                // only allow a response after the final 3rd step (not 1 or 2)
                // only log the data after the final 3rd step (not 1 or 2)
                // steps 1 and 2 each last 1,000 ms (1 sec)
                // step 3 lasts 10,000ms (10 sec) if the child does not respond
                if (j == 3) {
                    var allow_response = true
                    // var cur_data = {set:cur_trials[i]['set'],rep:cur_trials[i]['rep'],block:cur_trials[i]['block'],condition:cur_trials[i]['condition'],tr_num_form:cur_trials[i]['form_tr_num'],target:cur_trials[i]['name'],target_loc:cur_trials[i]['target'],correct_response:cur_trials[i]['correct_response']}
                    var cur_data = {week:cur_trials[i]['week'],order_counterbalance:cur_trials[i]['order_counterbalance'],alien_counterbalance:cur_trials[i]['alien_counterbalance'],set_counterbalance:cur_trials[i]['set_counterbalance'],block:cur_trials[i]['block'],tr_num_form:cur_trials[i]['form_tr_num'],condition:cur_trials[i]['condition'],teaching_block:cur_trials[i]['teaching_block'],name:cur_trials[i]['name'],target:cur_trials[i]['target'],correct_response:cur_trials[i]['correct_response']}
                    var cur_dur = 10000
                } else {
                    var allow_response = false
                    var cur_data = {}
                    var cur_dur = 1000
                }
                
                // show the trial number followed by a blank screen before the 1st step
                // but not before the 2nd and 3rd step
                if (j == 1) {
                    var cur_timeline = [show_trial_num,blank_screen,form_prompt]
                } else {
                    var cur_timeline = [form_prompt]
                }

                var form_trial = {
                timeline: cur_timeline,
                timeline_variables:[
                    {tr_num: cur_tr_num,
                    name: cur_name,
                    dots: cur_dots,
                    response: allow_response,
                    tr_dur: cur_dur,
                    log_data: allow_response,
                    data: cur_data
                    }
                ],
                conditional_function: function() {
                    if(phase == 2 | phase == 3) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }
            timeline.push(form_trial)
        }
    }

        /*
        ----------------------
        ASSEMBLE LINK TRIALS
        ----------------------
        */

        var link_instructions = {
            timeline: [mae_screen],
            timeline_variables:[
                {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:32px;'>Great job! <br><br> Mae will show you three aliens and say one of their names. <br> Click the alien that goes with that name. </p>",
                choices: [imageStart+"next-button"+buttonStop]}
            ],
            conditional_function: function() {
                if(phase == 2 | phase == 3) {
                    return true
                } else {
                    return false
                }
            },
        }
                
        timeline.push(link_instructions)

        // var cur_trials = link_trials.filter(function(trial){return trial.set === 1})
        var cur_trials = link_trials

        for (var i = 0; i < cur_trials.length; i++) {

            // break between link blocks
            if (cur_trials[i]['block'] > 1 && cur_trials[i]['block_tr_num'] == 1) {
                var link_break = {
                    timeline: [mae_screen],
                    timeline_variables:[
                        {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:32px;'>Great job! <br><br> Mae will show you the aliens and say their names one more time. <br> Remember to click the alien that goes with that name. </p>",
                        choices: [imageStart+"next-button"+buttonStop]}
                    ],
                    conditional_function: function() {
                        if(phase == 2 | phase == 3) {
                            return true
                        } else {
                            return false
                        }
                    },
                }
                
                timeline.push(link_break)
            }

            // var cur_tr_num = adjust_tr_num(cur_trials[i]['tr_num'])
            var cur_tr_num = cur_trials[i]['tr_num']

            var cur_name = audioExt+"link/"+cur_trials[i]['name']+".wav"

            var cur_aliens = []
            cur_aliens.push(imageStart+cur_trials[i]['top_left']+imageStop)
            cur_aliens.push(imageStart+cur_trials[i]['top_right']+imageStop)
            cur_aliens.push(imageStart+cur_trials[i]['bot_center']+imageStop)

            // var cur_data = {set:cur_trials[i]['set'],rep:cur_trials[i]['rep'],block:cur_trials[i]['block'],condition:cur_trials[i]['condition'],tr_num_link:cur_trials[i]['link_tr_num'],target:cur_trials[i]['name'],target_loc:cur_trials[i]['target'],correct_response:cur_trials[i]['correct_response']}
            // editing REDCap data
            var cur_data = {week:cur_trials[i]['week'],order_counterbalance:cur_trials[i]['order_counterbalance'],alien_counterbalance:cur_trials[i]['alien_counterbalance'],set_counterbalance:cur_trials[i]['set_counterbalance'],block:cur_trials[i]['block'],tr_num_link:cur_trials[i]['link_tr_num'],condition:cur_trials[i]['condition'],teaching_block:cur_trials[i]['teaching_block'],name:cur_trials[i]['name'],alien:cur_trials[i]['alien'],target:cur_trials[i]['target'],correct_response:cur_trials[i]['correct_response']}

            var link_trial = {
                timeline: [show_trial_num,blank_screen,link_prompt],
                timeline_variables:[
                    {tr_num: cur_tr_num,
                    name: cur_name,
                    aliens: cur_aliens,
                    response: true,
                    tr_dur: 10000,
                    data: cur_data
                    }
                ],
                conditional_function: function() {
                    if(phase == 2 | phase == 3) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }
            timeline.push(link_trial)
        }


        /*
        --------------------------------
        ASSEMBLE LEXICAL DECISION TRIALS
        --------------------------------
        */

        var cur_trials = ld_trials

        var ld_instructions = {
            timeline: [mae_screen],
            timeline_variables:[
                {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:30px;'>Mae has learned so many alien words. <br>She sometimes gets confused about which words are English. <br><br> Mae will say some words. <br><br>If it is a real word in English, click on the smiley face. <br> If it is a made-up word, click on the frowny face. </p>",
                choices: [imageStart+"next-button"+buttonStop]}
            ],
            conditional_function: function() {
                if(phase == 4) {
                    return true
                } else {
                    return false
                }
            },
        }
                
        timeline.push(ld_instructions)

        // Complete 6 practice trials with feedback
        // Repeat once more if accuracy < 50%

        var prac_trials = [
        {word:'cat.wav',name:'cat',type:'familiar',neighbor:'cat',correct_response:0},
        {word:'wat.wav',name:'cat',type:'novel',neighbor:'wat',correct_response:1},
        {word:'habby.wav',name:'happy',type:'novel',neighbor:'habby',correct_response:1},
        {word:'happy.wav',name:'happy',type:'familiar',neighbor:'happy',correct_response:0},
        {word:'run.wav',name:'run',type:'familiar',neighbor:'run',correct_response:0},
        {word:'rin.wav',name:'run',type:'novel',neighbor:'rin',correct_response:1}]

        var do_practice = true;

        for (var loop = 1; loop < 3; loop ++) {

            for (var i = 0; i < prac_trials.length; i++) {
                var ld_prac_trial = {
                    timeline: [blank_screen,ld_prompt,ld_feedback,show_ld_acc],
                    timeline_variables:[
                        {name: audioExt+"LD/"+prac_trials[i]['word'],
                        response: true,
                        tr_dur: 10000,
                        data: {week:cur_trials[1]['week'],order:cur_trials[1]['order'],set:cur_trials[1]['set'],block:loop,tr_num_ld:0,condition:'ld_practice',target:prac_trials[i]['name'],type:prac_trials[i]['type'],neighbor:prac_trials[i]['neighbor'],correct_response:prac_trials[i]['correct_response']} // ron update to pull set from global variable set by URL
                        }
                    ],
                    conditional_function: function() {

                        var cur_rep = jsPsych.data.get().filter({condition:"ld_practice"}).select('block').max()
                        var ld_prac_n = jsPsych.data.get().filter({condition:"ld_practice",block:cur_rep})
                        var ld_prac_correct = ld_prac_n.filter({correct:true}).count()
                        var ld_prac_accuracy = Math.round(ld_prac_correct/ld_prac_n.count()*100)
                        // console.log("cur rep:",cur_rep,", prac_n:",ld_prac_n,", prac_correct:",ld_prac_correct,", prac_acc:",ld_prac_accuracy)

                        if(ld_prac_n.count()==6 & ld_prac_accuracy >= 50) {do_practice = false}

                        if(phase == 4 & do_practice) {
                            return true;
                        } else {
                            return false;
                        }
                    }
                }
                timeline.push(ld_prac_trial)
            }
        }

        
        // for (var i = 0; i < prac_trials.length; i++) {
        //     var ld_prac_trial = {
        //         timeline: [blank_screen,ld_prompt,ld_feedback,ld_acc],
        //         timeline_variables:[
        //             {name: '/stimuli/sounds/LD/'+prac_trials[i]['word'],
        //             response: true,
        //             tr_dur: 10000,
        //             data: {set:1,rep:loop,condition:'practice',correct_response:prac_trials[i]['correct_response']} // ron update to pull set from global variable set by URL
        //             }
        //         ],
        //         conditional_function: function() {
        //             if(phase == 4) {
        //                 return true;
        //             } else {
        //                 return false;
        //             }
        //         }
        //     }
        //     timeline.push(ld_prac_trial)
        // }
        
        // timeline.push(ld_acc)

        // let ld_prac_correct = jsPsych.data.get().last(6).filter({condition:"practice",correct:true})
        // let ld_prac_accuracy = Math.round(ld_prac_correct.count()/6*100)
        // if (ld_prac_accuracy >= 50) {repeat_ld_prac = false}

        // var cur_trials = ld_trials.filter(function(trial){return trial.set === 1})

        var ld_start = {
            timeline: [mae_screen],
            timeline_variables:[
                {stimulus: imageStart+"mae"+imageStop+"<p style='font-size:30px;'>Great job!<br><br> Now it's time for you to do some more on your own.</p>",
                choices: [imageStart+"next-button"+buttonStop]}
            ],
            conditional_function: function() {
                if(phase == 4) {
                    return true
                } else {
                    return false
                }
            },
        }
                
        timeline.push(ld_start)

        for (var i = 0; i < cur_trials.length; i++) {
            
            // break between ld blocks
            if (cur_trials[i]['block'] > 1 && cur_trials[i]['block_tr_num'] == 1) {
                var ld_break = {
                    timeline: [break_screen],
                    timeline_variables:[
                        {break_message: "<p style='font-size:70px;'>Great job! Let's take a break. </p>"}
                    ],
                    conditional_function: function() {
                        if(phase == 4) {
                            return true
                        } else {
                            return false
                        }
                    }
                }
                timeline.push(ld_break)
            }

            // var cur_tr_num = adjust_tr_num(cur_trials[i]['tr_num'])
            var cur_tr_num = cur_trials[i]['tr_num']

            var cur_name = audioExt+"LD/"+cur_trials[i]['neighbor']+".wav"
            var cur_data = {week:cur_trials[i]['week'],order_counterbalance:cur_trials[i]['order_counterbalance'],set_counterbalance:cur_trials[i]['set_counterbalance'],block:cur_trials[i]['block'],tr_num_ld:cur_trials[i]['ld_tr_num'],condition:cur_trials[i]['condition'],target:cur_trials[i]['name'],type:cur_trials[i]['type'],neighbor:cur_trials[i]['neighbor'],correct_response:cur_trials[i]['correct_response']}

            var ld_trial = {
                timeline: [show_trial_num,blank_screen,ld_prompt],
                timeline_variables:[
                    {tr_num: cur_tr_num,
                    name: cur_name,
                    response: true,
                    tr_dur: 10000,
                    data: cur_data
                    }
                ],
                conditional_function: function() {
                    if(phase == 4) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }
            timeline.push(ld_trial)
        }

    return timeline

    }

    function startExperiment(preload_stims,teaching_trials,recall_trials,form_trials,link_trials,ld_trials) {
        jsPsych.run(createExperiment(preload_stims,teaching_trials,recall_trials,form_trials,link_trials,ld_trials))
    }

    // RON: add code to tag trial type in the data saved for each trial (right now it's just audio-button-response, etc.)
    // RON: add code to preload images and sounds

  </script>
</html>